<!DOCTYPE html>
<html>
  <meta charset="utf-8" />
  <body>
    <script src="//d3js.org/d3.v4.min.js"></script>

    <script
      src="https://unpkg.com/viz.js@1.8.2/viz.js"
      type="javascript/worker"
    ></script>
    <script src="https://unpkg.com/d3-graphviz@2.6.1/build/d3-graphviz.min.js"></script>

    <div id="graph" style="text-align: center;"></div>

    <script>
      var dots = [];
      var dotIndex = 0;

      function transitionFactory() {
        return d3
          .transition('main')
          .ease(d3.easeLinear)
          .delay(50)
          .duration(1000 * dotIndex);
      }

      async function fetchDots() {
        const res = await fetch('/dots');
        dots = JSON.parse(await res.text());
      }

      const graphviz = d3
        .select('#graph')
        .graphviz({
          engine: 'fdp',
          fit: true,
          width: window.screen.availWidth,
          height: window.screen.availHeight,
        })
        .logEvents(true)
        .transition(transitionFactory)
        .tweenShapes(true)
        .on('initEnd', render);

      async function render() {
        if (dots.length === 0) await fetchDots();
        const dot = dots[dotIndex % dots.length];
        graphviz.renderDot(dot).on('end', function() {
          dotIndex++;
          if (dotIndex !== dots.length) {
            render();
          }
        });
      }
    </script>
  </body>
</html>
